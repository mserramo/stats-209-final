---
title: "jobsdata"
output: pdf_document
date: "2023-12-02"
---
Di (treatment of interest) = indicator of patient i receiving flu shot(vaccine)
Yi (outcome) = indicator for flu-related hospital visits
Zi  (encouragement/assignment)= indicator of patient i's physician receiving a reminder letter indicating that the patient was eligible to receive the influenza vaccine under U.S. Public Health Service Criteria

## Covariates
```{r fludata}

fludata <- read.csv("~/Desktop/Fall 2023/STATS209/data/fludata.txt", sep="")
View(fludata)

#Covariate 1: age (age of patient)
d1_age <- fludata$age[fludata$receive == 1]
d0_age <- fludata$age[fludata$receive == 0] 
age_p <- t.test(d1_age, d0_age)$p.value

#Covariate 2: copd (indicator chronic obstructive pulmonary disease)
d1_copd <- fludata$copd[fludata$receive == 1]
d0_copd<- fludata$copd[fludata$receive == 0] 
copd_p <- t.test(d1_copd, d0_copd)$p.value

#Covariate 3: dm (indicator of diabetes)
d1_dm <- fludata$dm[fludata$receive == 1]
d0_dm <- fludata$dm[fludata$receive == 0] 
dm_p <- t.test(d1_dm, d0_dm)$p.value

#Covariate 4: heartd (indicator of heart disease)
d1_heartd <- fludata$heartd[fludata$receive == 1]
d0_heartd <- fludata$heartd[fludata$receive == 0] 
heartd_p <- t.test(d1_heartd, d0_heartd)$p.value

#Covariate 5: renal (indicator of renal disease)
d1_renal <- fludata$renal[fludata$receive == 1]
d0_renal <- fludata$renal[fludata$receive == 0] 
renal_p <- t.test(d1_renal, d0_renal)$p.value

#Covariate 6: liverd (indicator of liver disease)
d1_liverd <- fludata$liverd[fludata$receive == 1]
d0_liverd <- fludata$liverd[fludata$receive == 0] 
liverd_p <- t.test(d1_liverd, d0_liverd)$p.value

#Covariate 7: race (race of patient #unsure what 1 indicates.. white?)
d1_race <- fludata$race[fludata$receive == 1]
d0_race <- fludata$race[fludata$receive == 0] 
race_p <- t.test(d1_race, d0_race)$p.value

#Covariate 8: sex (gender of patient #unsure what 1 indicates)
d1_sex <- fludata$sex[fludata$receive == 1]
d0_sex <- fludata$sex[fludata$receive == 0] 
sex_p <- t.test(d1_sex, d0_sex)$p.value

```


```{r covariate p-values, echo=FALSE}
# Xi1 = age
cat("P-value for Age between Patients with and without Flu Shots: ", age_p, "\n")
cat("P-value for COPD between Patients with and without Flu Shots: ", copd_p, "\n")
cat("P-value for Diabetes between Patients with and without Flu Shots: ", dm_p, "\n")
cat("P-value for Heart Disease between Patients with and without Flu Shots: ", heartd_p, "\n")
cat("P-value for liverd between Patients with and without Flu Shots: ", liverd_p, "\n")
cat("P-value for race between Patients with and without Flu Shots: ", race_p, "\n")
cat("P-value for gender between Patients with and without Flu Shots: ", sex_p, "\n")
```

```{r covariate boxplots, echo=FALSE}
# Xi1 = age
boxplot(fludata$age ~ fludata$receive,
        xlab = "Flu Shot Status",
        ylab = "Age",
        names = c("No Flu Shot", "Flu Shot"),
        col = c("lightblue", "lightgreen"),
        outline = FALSE,
        width = c(0.5, 0.5))  

legend("topright", legend = c("No Flu Shot", "Flu Shot"), fill = c("lightblue", "lightgreen"))
title("Age for Patients with and without Flu Shots")


# Xi2 = COPD
copd_table <- table(fludata$receive, fludata$copd)
copd_proportions <- prop.table(copd_table, margin = 1)

barplot(copd_proportions, beside = TRUE, col = c("lightblue", "lightgreen"),
        names.arg = c("No Flu Shot", "Flu Shot"),
        main = "COPD Rates by Flu Shot Status",
        xlab = "Flu Shot Status", ylab = "Proportion")
legend("topright", legend = c("No COPD", "COPD"), fill = c("lightblue", "lightgreen"))
title("COPD Rates by Flu Shot Status")

```

\pagebreak
# IVREG
```{r}
# Z = assign
# D = receive
# Y = outcome
# Xi's = age, copd, sex

library(AER)

# without covariates
ivsum1 <- summary(ivreg(outcome ~ receive | assign , data=fludata))

# with age and copd (as did Hirano)
ivsum2 <- summary(ivreg(outcome ~ receive + age + copd | assign + age + copd, data=fludata))

# with age, copd, and sex
ivsum3 <- summary(ivreg(outcome ~ receive + age + copd + sex | assign + age + copd + sex, 
                        data=fludata))

```

Using the indicator of encouragment to receive the flu shot as the instrument, the effect of influenza vaccine on flu-related hospitalizations:
```{r ivreg result, echo=FALSE}
cat("Without covariates ", "\n")
print(ivsum1$coefficients["receive", ])

cat("With covariates age and copd (same as Hirano)", "\n")
print(ivsum2$coefficients["receive", ])

cat("With covariates age, COPD, and sex", "\n")
print(ivsum3$coefficients["receive", ])
```
## E-Value
```{r evalue, include=TRUE}
#e-value for encouragement and flu-related hospitalization relationship
Z0_Y0 <- sum(fludata$assign == 0 & fludata$outcome == 0) 
Z0_Y1 <- sum(fludata$assign == 0 & fludata$outcome == 1)
Z1_Y0 <- sum(fludata$assign == 1 & fludata$outcome == 0) 
Z1_Y1 <- sum(fludata$assign == 1 & fludata$outcome == 1)

ZY_table <- table(fludata$assign, fludata$outcome)

rownames(ZY_table) <- c("No Encouragement", "Encouragement")
colnames(ZY_table) <- c("No Flu Visit", "Flu Visit")

evalue <- function(rr) {
  rr + sqrt(rr*(rr - 1)) 
}

p1 = Z1_Y1/(Z1_Y1+Z1_Y0)
p0 = Z0_Y1/(Z0_Y1+Z0_Y0) 
rr =p1/p0
logrr = log(p1/p0)
se = sqrt(1/Z1_Y1+1/Z0_Y1-1/(Z1_Y1+Z1_Y0 )-1/(Z0_Y1+Z0_Y0))
upper = exp(logrr+1.96*se)
lower = exp(logrr -1.96*se)
evalue(rr)

#risk ratio is less than 1, so cannot calculate e-value

```

```{r evalue results, echo=FALSE}
print(ZY_table)
cat("\n")

cat("Risk Ratio: ", rr, "\n")
cat("95% Confidence Interval of Risk Ratio: [", round(lower, 4), ", ", round(upper, 4), "]\n")
cat("E-Value based on Point estimate(rr): ", evalue(rr), "\n")
cat("E-Value based on lower CI: ", evalue(lower), "\n")



```